---
title: "fig6_fitness_effects"
author: "rra"
date: "5/4/2020"
output: html_document
---


```{r}
rm(list = ls())
library(tidyverse)
library(data.table)
library(cowplot)
library(wesanderson)
library(ggplot2)
library(MASS)
library(qtl)
library(lme4)
library(arm)
library(lsmeans)
library(pbkrtest)
library(cowplot)
library(viridis)
library(qtlcharts)
library(readr)
library(ggfortify)
library(ggmap)
library(maps)
library(qtlcharts)
library(Hmisc)
library(data.table)
library(GridLMM)
library(grid)
library(gridExtra)
library(dabestr)

```



```{r}

load('data/fig_6/EffectsAllForRuben.Rimage')

DAdata <- ggplot_build(plot3DA)
DA <- DAdata$plot[[1]]
PHdata <- ggplot_build(plot3PH)
PH <- PHdata$plot[[1]]
ASIdata <- ggplot_build(plot3ASI)
ASI<- ASIdata$plot[[1]]
FWdata <- ggplot_build(plot3FW)
FW<- FWdata$plot[[1]]
BCWdata <- ggplot_build(plot3BCW)
BCW <- BCWdata$plot[[1]]
GWHdata <- ggplot_build(plot3GWH)
GWH<- BCWdata$plot[[1]]



DA_fig <- DA %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('Days to Anthesis') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none") 

PH_fig <- PH %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('Plant Height') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none")  

ASI_fig <- ASI %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('ASI') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none")  

FW_fig <- FW %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('Fresh Ear Weight') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none") 

BCW_fig <- BCW %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('Cob Weight') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none")   

GWH_fig <- FW %>%
  ggplot(aes(x = Elevation/1000, y = effect, fill=Test)) +
  geom_line() +
  scale_fill_manual(values=c("#dbd9d8", "#3630f0")) +
  geom_ribbon(aes(ymin = lower.CI, ymax = upper.CI, alpha = 0.4)) +
  labs(x=NULL, y=NULL) +
  theme_cowplot(12) +
  ggtitle('Grain Weight/ha') +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size=9)) +
  theme(legend.position = "none")  

plotG <- plot_grid(DA_fig, PH_fig, ASI_fig, FW_fig, BCW_fig, GWH_fig, align = "v", nrow=2)

y.grob <- textGrob("Effect of the highland allele", 
                   gp=gpar( col="black", fontsize=10), rot=90)
x.grob <- textGrob("Elevation (km)", 
                   gp=gpar( col="black", fontsize=12))
#add to plot
Gplot<-grid.arrange(arrangeGrob(plotG, left = y.grob, bottom = x.grob))

ggsave(plot= Gplot,height=6,width=12,dpi=200, filename="~/effects_pla.pdf", useDingbats=FALSE)

```
PLA Mutant analysis
```{r}
pla <- read_csv("data/fig_6/pla_crispr_ft.csv")

pla %>% 
  filter(genotype == "mut" | genotype == "wt") %>%
  #filter(DTA < 66) %>%
  ggplot(aes(x = genotype, y = DTA, color = genotype)) +
  geom_jitter(position=position_jitter(0.1), size = 1) +
  scale_color_manual(values=c("#1260ad", "#df1b23", "#fd6820", "#14ade8")) +
  stat_summary(fun.data=mean_sdl,fun.args = list(mult = 1), geom="pointrange", color = "black") +
  theme_cowplot() +
  #facet_grid(cols = vars(Cas9))
  #theme(legend.position="none") 
  
pla_std <- standardize(pla)

pla_dta_neg <- pla_std %>%
  filter(PLA == "Negative") 

pla_dta_pos <- pla_std %>%
  filter(PLA == "Positive") 

cohens_d(pla_dta_pos$DTA, pla_dta_neg$DTA)
hedges_g(pla_dta_pos$DTA, pla_dta_neg$DTA)
glass_delta(pla_dta_pos$DTA, pla_dta_neg$DTA)

interpret_d(d = 0.308, rules = "gignac2016")




#dabestr analysis

#create ASI variable

pla <- pla %>%
  mutate(ASI = DTS - DTA)


unpaired_DTS <- pla %>%
  filter(genotype == "mut" | genotype == "wt") %>%
  filter(!is.na(DTS)) %>%
  dabest(genotype, DTS,
         idx = list(c("wt", "mut")),
         paired = FALSE) %>%
  mean_diff()

effect_size_dts <- plot(unpaired_DTS, axes.title.fontsize = 14,
     palette = c(values=c("#df1b23", "#1260ad")),
     rawplot.ylabel = "",
     effsize.ylabel = "",
     rawplot.markersize = 2)

unpaired_DTA <- pla %>%
  filter(genotype == "mut" | genotype == "wt") %>%
  filter(!is.na(DTA)) %>%
  dabest(genotype, DTA,
         idx = list(c("wt", "mut")),
         paired = FALSE) %>%
  mean_diff()

effect_size_dta <- plot(unpaired_DTA, axes.title.fontsize = 14,
     palette = c(values=c("#df1b23", "#1260ad")),
     rawplot.ylabel = "",
     effsize.ylabel = "",
     rawplot.markersize = 2)

unpaired_ASI <- pla %>%
  filter(genotype == "mut" | genotype == "wt") %>%
  filter(!is.na(ASI)) %>%
  dabest(genotype, ASI,
         idx = list(c("wt", "mut")),
         paired = FALSE) %>%
  mean_diff()

effect_size_ASI <- plot(unpaired_ASI, axes.title.fontsize = 14,
     palette = c(values=c("#df1b23", "#1260ad")),
     rawplot.ylabel = "",
     effsize.ylabel = "",
     rawplot.markersize = 2)
    
 plat_ft <- plot_grid(effect_size_dts, effect_size_dta, effect_size_ASI, ncol = 3)    
 
ggsave(plot= plat_ft,height=6,width=12,dpi=200, filename="~/ft_pla.pdf", useDingbats=FALSE)

     
```


