---
title: "Fig 1 Code"
output: html_document
---
```{r}
rm(list = ls())
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggmap)
library(maps)
```



#HiLo panel analysis

```{r}
#file with hilo panel metadata

hilo_panel <- read.csv("data/fig_1/hilo_panel_info.csv") %>%
 mutate(ele = if_else(Elevation >=2000,"high","low")) %>%
 mutate(ele = factor(ele, levels=(c("low","high"))))

```

Plot map with location of accessions

```{r}

# palettes
pal <- c(dark_red     = "#df1b23",
         dark_blue    = "#1260ad",
         light_orange = "#fd6820", 
         light_blue   = "#14ade8")

# blue <-> cold <-> highland
meso_pal <- pal[c("dark_red", "dark_blue")] 
south_pal <- pal[c("light_orange", "light_blue")] 


meso <- subset(hilo_panel, Lat > 15)
south<- subset(hilo_panel, Lat < 15) 

borders <- c(-30,  35, -115, -50)
names(borders) <- c("bottom","top","left","right")
 
basemap <- get_stamenmap( 
  bbox = borders,
  zoom = 4, 
  maptype = "terrain-background",
  color = "bw")

ggmap(basemap,extent='device')

hilo_map <- ggmap(basemap, extent='device',
             base_layer = ggplot(hilo_panel, aes(x=Long, y=Lat))
             )  + 
   geom_point(data = meso,   
              color = meso_pal[factor(meso$ele)], size =  2) +
   geom_point(data = south, 
              color = south_pal[factor(south$ele)], size =  2) +
   theme(legend.position="none") 
hilo_map

# png("HiLo_map.png")
# hilo_map
# dev.off()
```


Fixing lipid names, it is a lot of fixing because of lack of a standard for names that would play nice with R column names :/

```{r}
########################################################################
# Lipid name format for plot labels
#
#[abbreviation][no space][carbon number][colon][number of desaturations][dot][isomer letter] 
# LC18:0
# PC38:5.A
########################################################################

has_isomer <- function(x){
# the compound must end with a number
# if it ends with a letter it is most likely an isomer
grepl("_{0,1}([A-Z])$|_{0,1}([A-Z])$", x)
}

to_dot_isomer <- function(x){
  # assuming an underline separtion between the compound
  # name and the isomer letter
  gsub("_{0,1}([A-Z])$","\\.\\1",x, perl =  TRUE)
}

# to_dot_isomer("PC_36_5_B")
# to_dot_isomer("PC_36_5B")

to_lipid_colon <- function(x) {
  # This will work with simple LPC PC TG names
  sub("_","",x) %>%
  sub("_",":",.)
}

to_colon_dot<- function(x) {
  x %>%
  to_lipid_colon() %>%
  to_dot_isomer()
}

remove_isomer <- function(x){
  gsub("\\..*$","",x, perl =  TRUE)
}

to_lipid_label <- function(x){
  to_lipid_colon(x) %>%
  to_dot_isomer() %>%
  remove_isomer() 
}



base_pheno <- read.csv("data/fig_1/hilo_panel_lipid.csv") 



# Excluding LPC PC ratios ------------------------------------------------------

# I'll recalculate the sums later exclude them now
# assuming sums have a lowercase 's' suffix
is_sum <- grepl( "s$", colnames(base_pheno)) 

# these ratios are in the file, we  won't use  them
ratios_in_file <- c("PC_LPC",
                     "PC34_1_LPC18_1",
                     "PC34_1_LPC18_2",
# These will be excluded too", ethers? plasmogens?:
                     "PC_p_34_2__PC_o_34_3", 
                     "PC_p_36_3__PC_o_36_4",
                     "PC_p_36_4__PC_o_36_5")

# these 'ratio' names will match  "[_]PC|[_]LPC"
with_denominator <- grepl( "[_]PC|[_]LPC", colnames(base_pheno)) 

colnames(base_pheno) <- gsub("_([A-Z])$",".\\1",colnames(base_pheno), perl =  TRUE)

with_isomers <- colnames(base_pheno)[grepl("\\.([A-Z])$",colnames(base_pheno))]

# Summarize lipids over isomers ----------------------
# uncomment if you want the summaries over the desaturation isomers
#
# isomer_sum <- base_pheno %>% 
#   select(with_isomers) %>%
#   t() %>% as.data.frame() %>%
#   group_by(., id = gsub('\\..*', '', rownames(.))) %>%
#   summarise_all(sum, na.rm = TRUE) %>%
#   data.frame() %>%
#   tibble::column_to_rownames(var = 'id') %>%
#   t() 
# 
# base_pheno <- cbind(base_pheno %>% 
#                        dplyr::select(-with_isomers), 
#                      isomer_sum) 

# Nightmare!
base_pheno %<>%
    janitor::clean_names(case = "all_caps") %>% 
  tibble()

exclude <- colnames(base_pheno)[is_sum | with_denominator] 

# Finally get rid of the unwanted lipids
base_pheno %<>%
  dplyr::select( -(all_of(exclude))) %>%
  tibble()


# fix non_lipid columns
# even better do this before making hilo_panel_lipid.csv

field_key <- c(PV="Lowland",MT = "Highland")

# add FIELD_LABEL, relocate LIPID_BATCH_NUMBER
# This will make my life easier

base_pheno %<>%
   mutate(LOC_YEAR = FIELD, .after = YEAR) %>%
   mutate(FIELD = recode(LOCATION, !!!field_key)) %>% 
   mutate(FIELD = factor(FIELD, levels = unname(field_key))) %>%
   relocate(LIPID_BATCH_NUMBER, .after = ELEVATION) 

lipid_pheno_cols <- base_pheno %>%
                select(CE_20_3:TG_56_4) %>%
                colnames() %>% sort

other_pheno_cols <- base_pheno %>%
                select(STD:EN) %>%
                colnames()
exp_attr <- base_pheno %>%
                select(ROW_ID:LIPID_BATCH_NUMBER) %>%
                colnames()
exp_attr

# 200 data points in  hilo_panel_lipid.csv
nrow(base_pheno)

# 108 'GENOTYPE's (landraces I guess?) have 1 rep
#  46 'GENOTYPE's  have 2 reps

base_pheno %>%
  group_by(FIELD, GENOTYPE) %>%
  summarise(reps = n()) %>%
  ungroup() %>%
  pull(reps) %>%
  table()

# 200 = 108 +2*46

# So I need to take the mean of the phenotypes where there are 2 reps.
# Repeated measures on a genotype in the same field 
# are not statistically independent with regards to landrace origin.
# we are assuming that each landrace is a random sample of highland/lowland
# population

# the following columns can be used to distinguish between the two reps
rep_def_cols  <- c("ROW_ID","ROW_NUM", "BLOCK","PAIR","LIPID_BATCH_NUMBER")

norep_attr_table <- base_pheno %>% 
  select(all_of(exp_attr)) %>% 
  select(-all_of(rep_def_cols)) %>%
  distinct() 

nrow(norep_attr_table)

# when I take those columns out I get a set of attributes 
# that I can use for the mean phenotype table

norep_attr <- colnames(norep_attr_table)

# First calculate derived phenotypes
# then do the means.

# make sums of signal per lipid_class 
lipid_class <- c("DG", "LPC", "PC", "SM", "TG")

lipid_calc <- base_pheno %>%
  select(FIELD, GENOTYPE)

for (class in lipid_class){
   lipid_calc[paste0(class,"s")] <- base_pheno %>%
    dplyr::select(dplyr::starts_with(paste0(class,"_"))) %>%
    rowSums(na.rm = TRUE)
}


# Add PCs/LPCs ratio
lipid_calc %<>% 
  mutate(PCs.LPCs = PCs/LPCs) %>%
  mutate(logPCs.LPCs = log10(PCs.LPCs)) 

lipid_calc_cols <- lipid_calc %>% select(-FIELD, -GENOTYPE) %>%
                    colnames()


# getting the mean phenotypes

mean_lipid<- base_pheno %>% 
  select(FIELD, GENOTYPE, 
         all_of(lipid_pheno_cols)) %>%
  dplyr::group_by(FIELD, GENOTYPE) %>%
  dplyr::summarise_if(is.numeric, function(x){
    mean(x,na.rm = TRUE) %>% 
      round(digits = 0) %>%
      as.integer()
    }) %>%
  dplyr::ungroup() 

nrow(mean_lipid)

mean_lipid_calc<- lipid_calc %>% 
  dplyr::group_by(FIELD, GENOTYPE) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::ungroup() 

nrow(mean_lipid)

mean_other<- base_pheno %>% 
  select(FIELD, GENOTYPE, 
         all_of(other_pheno_cols)) %>%
  dplyr::group_by(FIELD, GENOTYPE) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::ungroup() 

nrow(mean_other)

hilo_lipids <- norep_attr_table %>%
  left_join(mean_other) %>%
  left_join(mean_lipid) %>%
  left_join(mean_lipid_calc) 

other_pheno_cols
pheno_cols  <- c(other_pheno_cols,
                 lipid_pheno_cols,
                 lipid_calc_cols)


# change the name of the lipid cols to a nicer format

new_lipid_cols <- lipid_pheno_cols  %>% to_dot_isomer()

# change case of left columns referring to experimental attributes other than lipids

colnames(hilo_lipids)[ colnames(hilo_lipids) %in% lipid_pheno_cols ] <- new_lipid_cols

colnames(hilo_lipids)[1:length(norep_attr)] <- tolower(norep_attr)


hilo_lipids %<>%
  mutate(field = factor(field, levels = unname(field_key))) %>%
  mutate(elevation = factor(elevation, levels = c("Low","High")))

# I must have 154 (108 + 46, genotypes [single rep + two reps] )
nrow(hilo_lipids)

```


```{r}
# With long data instead of wide data I made this function nicer
# see get_signif_long
# It would be nice I if I also make common garden plot from long data
# instead of wide data 

get_signif <- function(data, y = "logPCs.LPCs"){ 
  # This test operates on wide data column per column
  test_formula <-  paste0(y, " ~ elevation" ) %>% formula()
  data %>%
    group_by(continent, field) %>%
    rstatix::t_test(., test_formula) %>%
    rstatix::add_x_position(x = "elevation") %>%
    rstatix::add_xy_position() %>%
    rstatix::adjust_pvalue(method = "BH") %>%
    rstatix::add_significance()  %>%
    dplyr::mutate( # p_raw = p, p = p.adj,
                   pval_fmt = format.pval(p.adj, digits = 2),
                   short.signif =  gsub("\\*.+","\\*",p.adj.signif, perl = TRUE)) %>%
    dplyr::arrange(p) 
}
```



```{r, fig.height = 2.3/2, fig.width = 8/2}
#  Common garden plot for PCs/LPCs ratio

logPC_LPC_str <-  expression("log"[10]*"(PCs/LPCs)") 

field_long <- c("Lowland Field", "Highland Field")

names(field_long) <-  levels(as.factor(hilo_lipids$field)) 

home <- c("Lowland", "Highland")
names(home) <-  levels(as.factor(hilo_lipids$elevation)) 

plot_common_garden <- function(data, var = NULL, signif = NULL){
  
    if(is.null(signif)){
      signif  <- get_signif(data)
    }
  
   data %>%
   ggplot(aes_string(x = "elevation", y = var, color = "elevation"))  +
   ggbeeswarm::geom_quasirandom(size = 2) +
   facet_grid(field ~ .,
       labeller = labeller(field = field_long),
       scales = "free_y") +
    xlab("Landrace Home") +
   stat_summary(
     fun.data=mean_sdl,
     fun.args = list(mult = 1),
     geom="pointrange", color = "black") +
   ggpubr::stat_pvalue_manual(
    signif, 
    label = "{pval_fmt}",
    bracket.nudge.y = 0.1,
    vjust = -0.3,
    #fontface = "bold",
    size = 5, bracket.size = 0.3,)  +
   scale_x_discrete(expand=c(0, 0.75),
                     labels = home) +
   scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  ggpubr::theme_classic2(base_size = 15) +
  theme( 
    axis.text.x = element_text(color = "black"),
    axis.title.y = element_text(vjust = 0),
    axis.title.x=element_text(vjust = 1, hjust = 0.5, size = 12),
    panel.border = element_blank(),
    #panel.spacing.y=unit(0, "lines"),
    strip.background = element_blank(),
    strip.text.x = element_blank(),
    strip.text.y = element_blank(),
    #strip.text.y = element_text(angle=90, vjust = 2, hjust = 0.5), # <<<
    legend.position ="none",
    plot.margin=unit(c(0.01,0.1,0.5,0.1), "cm")
  ) 
  }  



add_continent <- function(label = NULL, x = 1.5, y=-Inf){
label_data  <- data.frame(
    field = c("Lowland", "Highland"),
    elevation = "Low",
    label = c(label,"")
  )
    geom_text(
    data = label_data ,
    mapping = aes( x = x, y = y, label = label),
    fontface = "bold",
    color = "black",
    hjust = 0.5, vjust = -0.7, size = 16*0.35)
}  

mid_ranges <- function(data, var=NULL){
  c(range(data %>%
      filter(field == "Lowland")%>%
            pull(!!var)) %>% 
      mean(),
    range(data %>%
              filter(field == "Highland") %>%
              pull(!!var)) %>% 
        mean()
  )
}

add_field <- function(x = Inf,y=1){
   label_data <-  data.frame(
    field = c("Lowland", "Highland"),
    elevation = "High",
    label = field_long
  )
    geom_text(
    data = label_data,
    mapping = aes( x = x, y = y, label = label),
    color = "black",
    angle = 90,
    # fontface = "bold",
    hjust = 0.5, vjust = -0.3, size = 13*0.35, )
} 


# Count sample size for figure caption.
hilo_lipids  %>% 
  group_by(continent, genotype) %>%
  summarize(n()) %>% 
  group_by(continent)  %>%
  summarize(n())

# Is this significance right?
# this should match the significance calculated with
# long data

common_garden_signif <-   hilo_lipids %>%  
  select(all_of(norep_attr %>%tolower()), logPCs.LPCs) %>%
  get_signif(y = "logPCs.LPCs")

common_garden_signif  %>%
  select(field:p,p.adj)

# version for  mean +- 1 sd
fig <- ggpubr::ggarrange( 
  #quartz(height = 3.5, width = 2.2)
  hilo_lipids %>%
    dplyr::filter(continent == "Mex" ) %>%
    plot_common_garden(
      var = "logPCs.LPCs", 
      signif = common_garden_signif %>%
               filter(continent == "Mex")) +
    add_continent(label = "Mesoamerica", y = -Inf) +
    add_field(y = c(1.5, 1)) +
    scale_y_continuous(name = logPC_LPC_str, 
                    limits = c(-0.3, 2.5), 
                    breaks = 0:2,
                    expand = expansion(mult = c(0, 0.1))
                    ) +
    scale_color_manual(values = unname(meso_pal)) +
    scale_fill_manual(values =  unname(meso_pal)),
  
  hilo_lipids %>%
    dplyr::filter(continent == "SA") %>%
  plot_common_garden(
      var = "logPCs.LPCs", 
      signif = common_garden_signif %>%
               filter(continent == "SA")) +
    add_continent(label = "South America", y = -Inf) +
    add_field(y = c(1.2, 0.7)) +
    scale_y_continuous(name = logPC_LPC_str,
                   limits = c(-0.7, 2.3),
                   breaks = c(0:2),
                   expand = expansion(mult = c(0, .1))
                   ) +
    scale_color_manual(values = unname(south_pal)) +
    scale_fill_manual(values =  unname(south_pal)),
  nrow = 2
)

fig 

ggsave(file = "Fig1A.png",
       fig,
       width = 2.3, height = 8,
       units = "in", dpi = "print",
       bg = "transparent")
                    
```


Qst-Fst 

``````{r, fig.height = 7, fig.width = 3.5}

# (I think we must recalculate the Qst to match the RILs methods
# i.e. summing over the desaturation isomers).
# Additionally I have just the Fst for Mesoamerica
Fst_meso = 0.01984786
# I estimated Fst for southamerica from an earlier plot
Fst_south = 0.031
# Where is this Fst value? recalculate too? I would need the genotypes
# I'll work with this now

Qst_Fst <- read.csv("data/fig_1/qst_df.csv")
Qst_Fst$metabolite_old <-  Qst_Fst$metabolite

# Now fix the lipid names in this file! :/ ---------------------------

#carbon number desaturation names
Qst_Fst$with_isomer <- has_isomer(Qst_Fst$metabolite_old)

Qst_Fst$metabolite <- Qst_Fst$metabolite %>%
  janitor::make_clean_names(case = "all_caps") %>% 
  to_dot_isomer()

Qst_Fst$lipid_label <- Qst_Fst$metabolite  %>%
  # just n_carbons:n_desaturations
  to_colon_dot() %>%
  remove_isomer()


by_continent<- function(x, Qst_col =  "qst_elevation_mex") {
 x %>%
  mutate(Qst = x[,Qst_col]) %>%
      dplyr::select(cluster,metabolite,lipid_label, Qst)  %>%
    arrange(-Qst) %>%
    droplevels() %>% # I think this line is making my life difficult for plots
  mutate(metabolite = forcats::fct_reorder(metabolite , Qst),
         lipid_label = forcats::fct_reorder(lipid_label, Qst)) 
}

# I'll be using this function for a parallele analysis
get_top_by_cluster <- function(x,top =1){
   x %>%
    group_by(cluster) %>%
    dplyr::arrange(-Qst) %>%
     filter(row_number() == top) %>%  
    ungroup() 
}

plot_Qst <- function(x, Fst = NULL){
 
  Qst_xlab <- expression(italic("Q"["ST"]))
 
  ggplot(data = x, aes(x = Qst, 
             y = metabolite, col = Qst)) +
  geom_point(size = 3) +  
  scale_y_discrete( breaks= x$metabolite,
         labels= x$lipid_label) +
  scale_color_viridis_c(option = "plasma", direction = -1) +
  xlab(Qst_xlab)+
  xlim(0,1) +
  geom_vline(xintercept = Fst, color="red", size= 1) +
  ggpubr::theme_classic2(base_size = 18) +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.title.x = element_text(vjust = 1.5,size = 16),
        plot.margin=unit(c(0.1,0.2,-0.1,0.1), "cm")
        )
}

```



```{r}

# retrieve just PCs LPCs by continent
in_cluster <- !is.na(Qst_Fst$cluster)
Qst_in_cluster <- Qst_Fst %>% filter(in_cluster)

in_hilo_lipids <- Qst_Fst$metabolite %in% colnames(hilo_lipids)

# "PC_36_1" "DG_36_3" are not in  hilo_lipids
Qst_Fst$metabolite[!in_hilo_lipids]

mesoamerica_Qst <- Qst_Fst%>%
  filter(in_hilo_lipids  & in_cluster) %>%
  filter(class %in% c("PC","LPC")) %>%
  by_continent(Qst_col = "qst_elevation_mex") %>%
  get_top_by_cluster(top = 1)

nrow(mesoamerica_Qst)


southamerica_Qst <- Qst_Fst%>%
  filter(in_hilo_lipids  & in_cluster) %>%
  filter(class %in% c("PC","LPC")) %>%
  by_continent(Qst_col = "qst_elevation_sa") %>%
  get_top_by_cluster(top = 1)

nrow(southamerica_Qst)

# Pivot and scale data  -----------------------
# Transformmin to long data for correct statistical significance
#  for multiple comparisons of metabolites
scale_lipids <- function(data = NULL, cols = NULL){
   data %>%
    dplyr::select(all_of(norep_attr %>% tolower()),
                  all_of(cols)) %>%
    dplyr::mutate_if(colnames(.) %in% cols ,
                     function(x){scale(x) %>% as.vector()}) 
}

pivot_lipids <- function(data = NULL, cols = NULL, 
                         to = "signal"){
data  %>%
    dplyr::select(all_of(norep_attr %>% tolower()),
                  all_of(cols))  %>%
    tidyr::pivot_longer(
      cols = all_of(cols), 
      names_to = "metabolite", 
      values_to = to
    ) %>%   
#    mutate(elevation = factor(elevation, labels = home_label)) %>% # make optional
    mutate(lipid_label =  to_lipid_label(metabolite)) %>%
    mutate(metabolite = factor( metabolite, levels =  cols)
    ) 
}

meso_lipids <- hilo_lipids %>% filter(continent == "Mex")
south_lipids <- hilo_lipids %>% filter(continent == "SA")


Qst_lipids <- mesoamerica_Qst$metabolite %>% as.character()
no_data <- Qst_lipids[!Qst_lipids %in% colnames(hilo_lipids)]
# PC36:1 is absent from hilo_lipids!
# But it has a calculated Qst value why?
no_data
# these data must be in the raw file in the QTL folder
# work with the other 11 for now add an empty row for 36:1
meso_selected <- Qst_lipids[Qst_lipids %in% colnames(hilo_lipids)]

scaled_meso <- meso_lipids %>% droplevels() %>%
  scale_lipids(cols = meso_selected) %>%
  pivot_lipids(cols = meso_selected)
  

Qst_lipids <- southamerica_Qst$metabolite %>% as.character()
no_data <- Qst_lipids[!Qst_lipids %in% colnames(hilo_lipids)]
south_selected <- Qst_lipids[Qst_lipids %in% colnames(hilo_lipids)]

scaled_south <- south_lipids %>% droplevels() %>%
  scale_lipids(cols = south_selected) %>%
  pivot_lipids(cols = south_selected)

```

```{r}
# With long data I don't need the lapply over the column names
# just group_by(field, metabolite) 
# and inside the get_signif function
# signal ~ elevation 

get_signif_long <- function(data){ 
  test_formula <-  signal ~ elevation
  # make all species test
  data %>%
  group_by(continent, field, metabolite) %>%
  rstatix::t_test(., test_formula) %>%
  rstatix::add_x_position(x = "elevation") %>%
  rstatix::add_xy_position() %>%
  rstatix::adjust_pvalue(method = "BH") %>%
  rstatix::add_significance()  %>%
  dplyr::mutate( # p_raw = p, p = p.adj,
                 pval_fmt = format.pval(p.adj, digits = 2),
                 short.signif =  gsub("\\*.+","\\*",p.adj.signif, perl = TRUE)) %>%
  dplyr::arrange(p) 
}

```

```{r}

# Does the wide data calculated significance match with
# the long data one?

common_garden_signif_long <-   hilo_lipids %>% 
  pivot_lipids(cols = "logPCs.LPCs") %>%
  droplevels() %>%
  get_signif_long()

# Nice! they match
common_garden_signif  %>%
  select(field:p,p.adj)

common_garden_signif_long  %>%
  select(field:p,p.adj)


y_position  <-  function(x, var){
  x %>% filter(metabolite == var) %>% pull(signal) %>% max()
}
  
# t_test for the metepec experiment (highland field)
# corrected for all 4 comparisons
get_signif_long(
  hilo_lipids %>%
    pivot_lipids(cols = "PCs.LPCs") 
) %>%
  select(field:p, p.adj)

```

```{r}
# plotting metabolite pairwise difference between fields
plot_diff <- function(
  data, Qst =  NULL, 
  signif = NULL ){
  
  lipid_labeller <- levels(Qst$metabolite) %>% to_lipid_label()
  names(lipid_labeller)  <- levels(Qst$metabolite)

  if(is.null(signif)){
    signif  <- get_signif_long(data)
  }

  # data is in long format!!!!!
lipid_Qst  <-  data %>%
    right_join(Qst) %>%
    mutate(metabolite = forcats::fct_reorder(metabolite, Qst)) 

 lipid_Qst  %>%
  ggplot(aes(y = signal, x = elevation, color = elevation)) +
  xlab("Landrace Home") +
  ggbeeswarm::geom_quasirandom() +
  stat_summary(
       fun.data=mean_sdl,
       fun.args = list(mult = 1),
       geom="pointrange", color = "black") +
 ggpubr::stat_pvalue_manual(
  signif, 
  label = "short.signif",
  bracket.nudge.y = 0.1,
  vjust = -0.3,
  #fontface = "bold",
  size = 5, bracket.size = 0.3) +
  scale_y_continuous( expand = expansion(mult = c(0.1, .2))) +
  facet_wrap(. ~ metabolite,
             scales = "free_x",
             ncol = 12,
       labeller = labeller(field = field_long,
                           metabolite = lipid_labeller)) +
  scale_x_discrete(labels= c("L","H")) +
  ggpubr::theme_classic2(base_size = 15) +
    theme( legend.position = "none",
         panel.spacing = unit(0, "lines"),
         axis.title = element_blank(),
         strip.background = element_blank(),
         strip.placement = "outside") 
}
```


```{r}
# Selected lipids per cluster
# Not clear what was the criteria forr selecting these
# particular metabolites but this is the list

figure_selected <- c("LPC_18_0","PC_35_3", "LPC_18_1", "LPC_18_3", 
                     "LPC_16_0", "PC_33_2", "PC_36_2",  "PC_32_1",
                     "PC_34_2", "PC_36_5.A","PC_38_5.A", "PC_35_2")

# Check whether there are many isomers per lipid
#
# Qst_Fst %>% 
#   mutate(Qst = qst_elevation_mex) %>%
#   arrange(lipid_label)
#
# No, no isomers found the list is OK

mesoamerica_Qst <- Qst_Fst %>%
  filter(metabolite %in% figure_selected) %>%
  by_continent( Qst_col = "qst_elevation_mex")

southamerica_Qst <- Qst_Fst %>%
  filter(metabolite %in% figure_selected) %>%
  by_continent(  Qst_col = "qst_elevation_sa")


scaled_meso <- hilo_lipids %>%
  filter(continent == "Mex") %>%
  select(all_of(norep_attr %>% tolower()),
         all_of(figure_selected)) %>%
  scale_lipids(cols = figure_selected) %>%
  pivot_lipids(cols = figure_selected)
  
scaled_south <- hilo_lipids %>%
  filter(continent == "SA") %>%
  select(all_of(norep_attr %>% tolower()),
         all_of(figure_selected)) %>%
  scale_lipids(cols = figure_selected) %>%
  pivot_lipids(cols = figure_selected)

meso_high_diff_plot <- scaled_meso  %>%
  filter(field == "Highland") %>%
  plot_diff(
    Qst = mesoamerica_Qst,
    signif = get_signif_long(scaled_meso) %>%  # significance data from both fields
            droplevels() %>%
      filter(continent =="Mex", field == "Highland") # just plot the significance for Highlands
  ) +
  ylab("Z-score") +
  scale_color_manual(values = unname(meso_pal))


south_high_diff_plot <-  scaled_south %>%
  filter(field == "Highland") %>%
  plot_diff(
    Qst = southamerica_Qst,
    signif = get_signif_long(scaled_south) %>%      # significance data from both fields
      droplevels() %>%
      filter(continent =="SA", field == "Highland") # just plot the significance for Highlands
  ) +
  ylab("Z-score") +
  scale_color_manual(values = unname(south_pal))

continent_field_plot <-
  ggpubr::ggarrange(
    meso_high_diff_plot,
    south_high_diff_plot,align = "hv", 
    legend = "none",
    common.legend = TRUE,
    nrow = 2
  )


ggsave(file = "home_sp_field_diff.png",
       continent_field_plot,
       width = 12, height = 7,
       units = "in", dpi = "print",
       bg = "transparent")

#  In the highland field the difference 
#  in diverging lipids (Qst >Fst) 
#  is significant between highland and lowland samples
#  just for:
#  PC38:5 in Mesoamerican landraces
get_signif_long(scaled_meso) %>%
  select(field:p,p.adj) %>%
  print(n =25)

#  PC35:2 in Southamerican  landraces
#  (PC38:5 Qst < Fst in Southamerica even though the difference is significant)

get_signif_long(scaled_south) %>%
  select(field:p,p.adj) %>%
  print(n =25)

# Matching effect of highland origin is positive on PC38:5,
# that means that highland Mesoamerican landraces have 
# higher PC38:5 signal than lowland landraces when grown
# at the highland field.

# This significance changes depending on the list of species
# tested! See what happens when I pick the highest Qst


```

```{r}
# Plotting Qst values for the selected lipid species

# Make sure the order of metabolitas matches
# thw Qst statistic

selected_Qst_meso <- data.frame(metabolite  = figure_selected) %>%
  left_join(Qst_Fst %>%
              mutate(Qst = qst_elevation_mex)) %>%
  mutate(metabolite = forcats::fct_reorder(metabolite,Qst))%>%
  arrange(-Qst)
nrow(selected_Qst_meso)

selected_Qst_south <- data.frame(metabolite  = figure_selected) %>%
  left_join(Qst_Fst %>%
              mutate(Qst = qst_elevation_sa)) %>%
  mutate(metabolite = forcats::fct_reorder(metabolite,Qst))%>%
  arrange(-Qst)
nrow(selected_Qst_south)

selected_Qst_south  %>% dplyr::select(metabolite,lipid_label, Qst) 

# the threshold for South America is ~ 0.031
# Qst(LPC_18_1)) < Fst Qst(LPC_34_2))
# but I don't have the exact value
#  Finally 

meso_xlab <- expression(italic("Q"["ST"]) ~ "Mesoamerica")
south_xlab <- expression(italic("Q"["ST"]) ~ "South America")
        

Qst_plot <- ggpubr::ggarrange(
    plot_Qst(selected_Qst_meso, 
             Fst   = 0.01984786) + 
      xlim(0,0.3) +
      xlab(meso_xlab),
    plot_Qst(selected_Qst_south,
             Fst = 0.031) + 
      xlim(0,0.3)+
      xlab(south_xlab),
    nrow = 2
) 

ggsave(file = "Qst_plot.png",
       Qst_plot,
       width = 4, height = 8,
       units = "in", dpi = "print",
       bg = "transparent")

```

